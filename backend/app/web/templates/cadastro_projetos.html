{% extends "base.html" %}

{% block title %}Cadastro de Projeto{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
        <!-- Cabeçalho -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Cadastro de Projeto</h1>
            <p class="text-gray-600">Preencha as informações do projeto arquitetônico</p>
        </div>

        <!-- Formulário -->
        <form id="projetoForm" 
              class="bg-white rounded-lg shadow-md p-6" 
              hx-post="/cadastrar-projeto" 
              hx-target="body"
              hx-swap="none"
              hx-indicator="#loading-indicator"
              hx-on::before-request="showLoading()"
              hx-on::after-request="handleFormResponse(event)"
              hx-on::response-error="handleFormError(event)">
            <!-- Passo 1: Identificação do Projeto -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">1. Identificação do Projeto</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="nome_projeto" class="block text-sm font-medium text-gray-700 mb-1">
                            Nome do Projeto *
                        </label>
                        <input type="text" 
                               id="nome_projeto" 
                               name="nome_projeto" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Ex: Residência Família Silva"
                               required>
                    </div>

                    <div>
                        <label for="tipo_empreendimento" class="block text-sm font-medium text-gray-700 mb-1">
                            Tipo de Empreendimento *
                        </label>
                        <select id="tipo_empreendimento" 
                                name="tipo_empreendimento" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                required>
                            <option value="">Selecione</option>
                            <option value="Residencial">Residencial</option>
                            <option value="Comercial">Comercial</option>
                            <option value="Misto">Misto</option>
                        </select>
                    </div>
                </div>

                <div class="mt-4">
                    <label for="natureza" class="block text-sm font-medium text-gray-700 mb-1">
                        Natureza do Empreendimento *
                    </label>
                    <select id="natureza" 
                            name="natureza" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required>
                        <option value="">Selecione</option>
                        <option value="Desmembramento">Desmembramento</option>
                        <option value="Loteamento e Condomínio">Loteamento e Condomínio</option>
                        <option value="Arquitetonico">Arquitetonico</option>
                        <option value="Urbanistico">Urbanistico</option>
                        <option value="Não se aplica">Não se aplica</option>
                    </select>
                </div>

                <div class="mt-4">
                    <label for="descricao" class="block text-sm font-medium text-gray-700 mb-1">
                        Descrição do Projeto
                    </label>
                    <textarea id="descricao" 
                              name="descricao" 
                              rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="Descreva brevemente o projeto..."></textarea>
                </div>
            </div>

            <!-- Passo 2: Associações (Obrigatórias) -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">2. Associações</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Cliente Proprietário *
                        </label>
                        <div class="flex gap-2">
                            <input type="hidden" id="cliente_id" name="cliente_id" value="" required>
                            <input type="text" 
                                   id="cliente_nome" 
                                   placeholder="Selecione um cliente"
                                   readonly
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-md bg-gray-50"
                                   required>
                            <button type="button" 
                                    onclick="abrirModalClientes()"
                                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                Consultar
                            </button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Terreno do Projeto *
                        </label>
                        <div class="flex gap-2">
                            <input type="hidden" id="terreno_id" name="terreno_id" value="" required>
                            <input type="text" 
                                   id="terreno_info" 
                                   placeholder="Selecione um terreno"
                                   readonly
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-md bg-gray-50"
                                   required>
                            <button type="button" 
                                    onclick="abrirModalTerrenos()"
                                    class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                                Consultar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Passo 3: Dados Técnicos -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">3. Dados Técnicos</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="pavimentos" class="block text-sm font-medium text-gray-700 mb-1">
                            Número de Pavimentos
                            <span class="text-red-500" id="pavimentos-required" style="display: none;">*</span>
                        </label>
                        <input type="number" 
                               id="pavimentos" 
                               name="pavimentos" 
                               min="1" 
                               max="50"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Ex: 2">
                        <div id="pavimentos-info" class="mt-1 text-xs text-blue-600" style="display: none;">
                            <span id="pavimentos-limit-text"></span>
                        </div>
                    </div>

                    <div>
                        <label for="altura_total" class="block text-sm font-medium text-gray-700 mb-1">
                            Altura Total (m)
                            <span class="text-red-500" id="altura-required" style="display: none;">*</span>
                        </label>
                        <input type="number" 
                               id="altura_total" 
                               name="altura_total" 
                               step="0.01" 
                               min="0" 
                               max="200"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Ex: 8.50">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div>
                        <label for="area_construida" class="block text-sm font-medium text-gray-700 mb-1">
                            Área Construída (m²)
                        </label>
                        <input type="number" 
                               id="area_construida" 
                               name="area_construida" 
                               step="0.01" 
                               min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Ex: 150.00">
                    </div>

                    <div id="area-minima-container" style="display: none;">
                        <label for="area_minima_lote" class="block text-sm font-medium text-gray-700 mb-1">
                            Área Mínima do Lote (m²)
                            <span class="text-red-500">*</span>
                            <span class="text-blue-500 text-sm">ℹ️ Para loteamentos</span>
                        </label>
                        <input type="number" 
                               id="area_minima_lote" 
                               name="area_minima_lote" 
                               step="0.01" 
                               min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Ex: 360.00">
                    </div>
                </div>
            </div>

            <!-- Passo 4: Dados Especiais -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">4. Dados Especiais (Zonas ZCT2/ZCT4)</h2>
                
                <div id="avenida-container" style="display: none;">
                    <label for="avenida" class="block text-sm font-medium text-gray-700 mb-1">
                        Avenida
                        <span class="text-red-500">*</span>
                        <span class="text-blue-500 text-sm">ℹ️ Necessário para ZCT2/ZCT4</span>
                    </label>
                    <select id="avenida" 
                            name="avenida" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione a avenida</option>
                        <option value="Av. Porto Alegre">Av. Porto Alegre</option>
                        <option value="Av. dos Emigrantes">Av. dos Emigrantes</option>
                        <option value="Av. Paulista">Av. Paulista</option>
                        <option value="Av. Brasil">Av. Brasil</option>
                        <option value="Av. Joao Natalino Brescansin">Av. João Natalino Brescansin</option>
                        <option value="Av. Tancredo Neves">Av. Tancredo Neves</option>
                    </select>
                </div>

                <div class="mt-4">
                    <label for="observacoes" class="block text-sm font-medium text-gray-700 mb-1">
                        Observações
                    </label>
                    <textarea id="observacoes" 
                              name="observacoes" 
                              rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="Observações adicionais sobre o projeto..."></textarea>
                </div>
            </div>

            <!-- Botões -->
            <div class="flex justify-between items-center pt-6 border-t">
                <a href="/dashboard" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                    ← Voltar ao Dashboard
                </a>
                
                <div class="flex space-x-4">
                    <button type="button" 
                            class="px-6 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors"
                            onclick="resetForm(true)">
                        Limpar
                    </button>
                    <button type="submit" 
                            class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors flex items-center"
                            id="submit-btn">
                        <span id="btn-text">Cadastrar Projeto</span>
                        <span id="loading-indicator" class="hidden">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Cadastrando...
                        </span>
                    </button>
                </div>
            </div>
        </form>

        <!-- Resposta do Formulário -->
        <div id="form-response" class="mt-4">
            <div id="success-message" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium" id="success-text">Projeto cadastrado com sucesso!</p>
                    </div>
                </div>
            </div>
            
            <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium" id="error-text">Erro ao cadastrar projeto!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Consulta de Clientes -->
<div id="modalClientes" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[80vh] overflow-hidden">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-semibold text-gray-800">Consultar Clientes</h3>
                    <button onclick="fecharModalClientes()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="mt-4">
                    <input type="text" 
                           id="buscaCliente" 
                           placeholder="Buscar por nome, CPF/CNPJ..."
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           onkeyup="buscarClientes()">
                </div>
            </div>
            <div class="p-6 overflow-y-auto max-h-96">
                <div id="listaClientes">
                    <!-- Lista será carregada aqui -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Consulta de Terrenos -->
<div id="modalTerrenos" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[80vh] overflow-hidden">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-semibold text-gray-800">Consultar Terrenos</h3>
                    <button onclick="fecharModalTerrenos()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="mt-4">
                    <input type="text" 
                           id="buscaTerreno" 
                           placeholder="Buscar por matrícula, bairro..."
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                           onkeyup="buscarTerrenos()">
                </div>
            </div>
            <div class="p-6 overflow-y-auto max-h-96">
                <div id="listaTerrenos">
                    <!-- Lista será carregada aqui -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Auto-populate terreno_id when cod_projeto is selected
document.getElementById('terreno_id').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    if (selectedOption.value) {
        // Se um terreno foi selecionado, pode-se preencher automaticamente alguns dados
        console.log('Terreno selecionado:', selectedOption.value);
    }
});

// Validação dinâmica por natureza
document.getElementById('natureza').addEventListener('change', function() {
    const natureza = this.value;
    const areaMinimaContainer = document.getElementById('area-minima-container');
    
    if (natureza === 'Desmembramento' || natureza === 'Loteamento e Condomínio') {
        areaMinimaContainer.style.display = 'block';
        document.getElementById('area_minima_lote').required = true;
    } else if (natureza === 'Não se aplica') {
        areaMinimaContainer.style.display = 'none';
        document.getElementById('area_minima_lote').required = false;
        document.getElementById('area_minima_lote').value = '';
    } else {
        areaMinimaContainer.style.display = 'none';
        document.getElementById('area_minima_lote').required = false;
    }
});

// Variáveis para controle dos modais
let timeoutClientes = null;
let timeoutTerrenos = null;

// Funções para abrir/fechar modais
function abrirModalClientes() {
    document.getElementById('modalClientes').classList.remove('hidden');
    buscarClientes(); // Carrega lista inicial
}

function fecharModalClientes() {
    document.getElementById('modalClientes').classList.add('hidden');
}

function abrirModalTerrenos() {
    document.getElementById('modalTerrenos').classList.remove('hidden');
    buscarTerrenos(); // Carrega lista inicial
}

function fecharModalTerrenos() {
    document.getElementById('modalTerrenos').classList.add('hidden');
}

// Busca clientes com debounce
function buscarClientes() {
    clearTimeout(timeoutClientes);
    timeoutClientes = setTimeout(() => {
        const termo = document.getElementById('buscaCliente').value;
        const url = `/projetos/consulta/clientes?q=${encodeURIComponent(termo)}`;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderizarListaClientes(data.clientes);
                } else {
                    document.getElementById('listaClientes').innerHTML = '<p class="text-red-500">Erro ao buscar clientes</p>';
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                document.getElementById('listaClientes').innerHTML = '<p class="text-red-500">Erro ao buscar clientes</p>';
            });
    }, 300);
}

// Busca terrenos com debounce
function buscarTerrenos() {
    clearTimeout(timeoutTerrenos);
    timeoutTerrenos = setTimeout(() => {
        const termo = document.getElementById('buscaTerreno').value;
        const url = `/projetos/consulta/terrenos?q=${encodeURIComponent(termo)}`;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderizarListaTerrenos(data.terrenos);
                } else {
                    document.getElementById('listaTerrenos').innerHTML = '<p class="text-red-500">Erro ao buscar terrenos</p>';
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                document.getElementById('listaTerrenos').innerHTML = '<p class="text-red-500">Erro ao buscar terrenos</p>';
            });
    }, 300);
}

// Renderiza lista de clientes
function renderizarListaClientes(clientes) {
    const container = document.getElementById('listaClientes');
    
    if (clientes.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum cliente encontrado</p>';
        return;
    }
    
    const html = clientes.map(cliente => `
        <div class="border rounded-lg p-4 mb-3 hover:bg-gray-50 cursor-pointer" onclick="selecionarCliente('${cliente.id}', '${cliente.nome}')">
            <div class="flex justify-between items-start">
                <div>
                    <h4 class="font-semibold text-gray-800">${cliente.nome}</h4>
                    <p class="text-sm text-gray-600">${cliente.cpf_cnpj} - ${cliente.tipo}</p>
                    ${cliente.endereco ? `<p class="text-sm text-gray-500">${cliente.endereco}</p>` : ''}
                    ${cliente.contato ? `<p class="text-sm text-gray-500">${cliente.contato}</p>` : ''}
                </div>
                <button class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                    Selecionar
                </button>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = html;
}

// Renderiza lista de terrenos
function renderizarListaTerrenos(terrenos) {
    const container = document.getElementById('listaTerrenos');
    
    if (terrenos.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum terreno encontrado</p>';
        return;
    }
    
    const html = terrenos.map(terreno => `
        <div class="border rounded-lg p-4 mb-3 hover:bg-gray-50 cursor-pointer" onclick="selecionarTerreno('${terreno.id}', '${terreno.cod_projeto}', '${terreno.matricula}', '${terreno.endereco}', '${terreno.zona}')">
            <div class="flex justify-between items-start">
                <div>
                    <h4 class="font-semibold text-gray-800">${terreno.cod_projeto} - ${terreno.matricula}</h4>
                    <p class="text-sm text-gray-600">${terreno.endereco}</p>
                    <p class="text-sm text-gray-500">${terreno.zona} - ${terreno.area}m² - ${terreno.municipio}/${terreno.estado}</p>
                </div>
                <button class="px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700">
                    Selecionar
                </button>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = html;
}

// Seleciona cliente
function selecionarCliente(id, nome) {
    document.getElementById('cliente_id').value = id;
    document.getElementById('cliente_nome').value = nome;
    fecharModalClientes();
}

// Seleciona terreno
function selecionarTerreno(id, codProjeto, matricula, endereco, zona) {
    document.getElementById('terreno_id').value = id;
    document.getElementById('terreno_info').value = `${codProjeto} - ${matricula} - ${endereco}`;
    fecharModalTerrenos();
    
    // Consulta zona e atualiza placeholders
    if (zona) {
        consultarZonaEAtualizarPlaceholders(zona);
    } else {
        // Se não temos a zona, busca ela
        buscarZonaDoTerreno(id);
    }
}

// Busca zona do terreno por ID
function buscarZonaDoTerreno(terrenoId) {
    fetch(`/terrenos/${terrenoId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.terreno) {
                consultarZonaEAtualizarPlaceholders(data.terreno.zona);
            }
        })
        .catch(error => {
            console.error('Erro ao buscar zona do terreno:', error);
        });
}

// Consulta zona e atualiza placeholders dos campos técnicos
function consultarZonaEAtualizarPlaceholders(zona) {
    console.log('Consultando zona:', zona);
    
    fetch(`/projetos/validacao/zona/${zona}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                atualizarPlaceholdersComLimites(data, zona);
            }
        })
        .catch(error => {
            console.error('Erro ao consultar zona:', error);
        });
}

// Atualiza placeholders com limites da zona
function atualizarPlaceholdersComLimites(validationData, zona) {
    console.log('Atualizando placeholders para zona:', zona, validationData);
    
    // Atualiza campo pavimentos
    const pavimentosField = document.getElementById('pavimentos');
    const pavimentosInfo = document.getElementById('pavimentos-info');
    const pavimentosLimitText = document.getElementById('pavimentos-limit-text');
    
    if (pavimentosField && pavimentosInfo && pavimentosLimitText) {
        // Busca limite de pavimentos na zona (implementação específica)
        const limitePavimentos = obterLimitePavimentosPorZona(zona);
        
        if (limitePavimentos) {
            // Atualiza placeholder
            pavimentosField.placeholder = `Ex: 2 (máx: ${limitePavimentos} para zona ${zona})`;
            
            // Atualiza atributo max
            pavimentosField.max = limitePavimentos;
            
            // Mostra informação adicional
            pavimentosLimitText.textContent = `Limite máximo: ${limitePavimentos} pavimentos para zona ${zona}`;
            pavimentosInfo.style.display = 'block';
            
            console.log(`Limite de pavimentos atualizado: ${limitePavimentos} para zona ${zona}`);
        } else {
            // Remove informações específicas da zona
            pavimentosField.placeholder = 'Ex: 2';
            pavimentosField.max = 50;
            pavimentosInfo.style.display = 'none';
        }
    }
}

// Obtém limite de pavimentos por zona (implementação específica da legislação)
function obterLimitePavimentosPorZona(zona) {
    const limitesPavimentos = {
        'ZAD1': 4,
        'ZAD2': 6,
        'ZC1': 8,
        'ZC2': 10,
        'ZCT1': 3,
        'ZCT2': 4,
        'ZCT3': 5,
        'ZCT4': 6,
        'ZH1': 2,
        'ZH2': 3,
        'ZH3': 4,
        'ZHL': 1,
        'ZEIS': 2,  // CORRIGIDO: LC 108/2009 - máximo 2 pavimentos
        'ZI1': 2,
        'ZI2': 3,
        'ZIA1': 2,
        'ZIA2': 3,
        'ZII': 2
    };
    
    return limitesPavimentos[zona] || null;
}

// Variáveis para controle de interação do usuário
let autoClearTimeout = null;
let userInteracting = false;
let formHasData = false;

// Funções para feedback visual - Padrão padronizado
function resetForm(manual = false) {
    // Cancela limpeza automática pendente
    if (autoClearTimeout) {
        clearTimeout(autoClearTimeout);
        autoClearTimeout = null;
    }
    
    document.getElementById('projetoForm').reset();
    clearMessages();
    
    // Limpa campos específicos do projeto
    document.getElementById('cliente_id').value = '';
    document.getElementById('terreno_id').value = '';
    document.getElementById('cliente_nome').value = '';
    document.getElementById('terreno_info').value = '';
    
    // Reset flags
    userInteracting = false;
    formHasData = false;
    
    if (manual) {
        console.log('Formulário limpo manualmente pelo usuário');
    } else {
        console.log('Formulário limpo automaticamente após cadastro bem-sucedido');
    }
}

function clearMessages() {
    document.getElementById('success-message').classList.add('hidden');
    document.getElementById('error-message').classList.add('hidden');
}

function showSuccess(message) {
    console.log('=== SHOW SUCCESS CHAMADO ===');
    console.log('Mensagem:', message);
    
    clearMessages();
    document.getElementById('success-text').textContent = message;
    document.getElementById('success-message').classList.remove('hidden');
    
    // RESET CRÍTICO: Reset userInteracting para permitir limpeza automática
    userInteracting = false;
    console.log('Cadastro bem-sucedido - resetando userInteracting para false');
    console.log('Agendando limpeza automática');
    
    // Agenda limpeza automática
    scheduleAutoClear();
}

function showError(message) {
    clearMessages();
    document.getElementById('error-text').textContent = message;
    document.getElementById('error-message').classList.remove('hidden');
}

function scheduleAutoClear() {
    // Cancela timeout anterior se existir
    if (autoClearTimeout) {
        clearTimeout(autoClearTimeout);
    }
    
    console.log('Agendando limpeza automática em 8 segundos...');
    console.log(`Status atual - userInteracting: ${userInteracting}, formHasData: ${formHasData}`);
    
    autoClearTimeout = setTimeout(() => {
        console.log('=== TIMEOUT DE 8 SEGUNDOS ATINGIDO ===');
        console.log(`Status final - userInteracting: ${userInteracting}, formHasData: ${formHasData}`);
        
        // Verifica se o usuário interagiu desde o cadastro
        if (userInteracting) {
            console.log('❌ Limpeza automática CANCELADA - usuário interagiu com o formulário');
            console.log('Formulário NÃO será limpo automaticamente');
        } else {
            console.log('✅ Executando limpeza automática - usuário NÃO interagiu');
            console.log('Formulário será limpo automaticamente');
            resetForm(false); // false = limpeza automática
        }
        autoClearTimeout = null;
    }, 8000);
}

function cancelAutoClear() {
    if (autoClearTimeout) {
        clearTimeout(autoClearTimeout);
        autoClearTimeout = null;
        console.log('Limpeza automática cancelada - usuário interagiu ou formulário tem dados');
    }
}

function detectUserInteraction() {
    userInteracting = true;
    console.log('Usuário interagindo com formulário - cancelando limpeza automática');
    
    // Cancela limpeza automática quando usuário interage
    cancelAutoClear();
}

function detectFormData() {
    const form = document.getElementById('projetoForm');
    const formData = new FormData(form);
    
    // Verifica se há dados significativos no formulário
    let hasData = false;
    for (let [key, value] of formData.entries()) {
        if (value && value.trim() !== '') {
            hasData = true;
            break;
        }
    }
    
    // Verifica campos específicos do projeto
    if (!hasData) {
        const clienteId = document.getElementById('cliente_id').value;
        const terrenoId = document.getElementById('terreno_id').value;
        const clienteNome = document.getElementById('cliente_nome').value;
        const terrenoInfo = document.getElementById('terreno_info').value;
        
        hasData = clienteId || terrenoId || clienteNome || terrenoInfo;
    }
    
    formHasData = hasData;
    console.log(`Detecção de dados - formHasData: ${formHasData}`);
}

function showLoading() {
    const btnText = document.getElementById('btn-text');
    const loadingIndicator = document.getElementById('loading-indicator');
    const submitBtn = document.getElementById('submit-btn');
    
    // Mostra estado de carregamento
    btnText.classList.add('hidden');
    loadingIndicator.classList.remove('hidden');
    submitBtn.disabled = true;
    
    // Limpa mensagens anteriores
    clearMessages();
}

function handleFormResponse(event) {
    const btnText = document.getElementById('btn-text');
    const loadingIndicator = document.getElementById('loading-indicator');
    const submitBtn = document.getElementById('submit-btn');
    
    // Remove estado de carregamento
    btnText.classList.remove('hidden');
    loadingIndicator.classList.add('hidden');
    submitBtn.disabled = false;
    
    console.log('Resposta recebida:', event.detail.xhr.responseText);
    
    try {
        const response = JSON.parse(event.detail.xhr.responseText);
        console.log('Response parsed:', response);
        
        if (response.success) {
            showSuccess(response.message);
            // A limpeza automática é gerenciada pela função showSuccess
        } else {
            showError(response.message || 'Erro desconhecido');
        }
    } catch (error) {
        console.error('Erro ao processar resposta:', error);
        showError('Erro de comunicação com o servidor');
    }
}

function handleFormError(event) {
    const btnText = document.getElementById('btn-text');
    const loadingIndicator = document.getElementById('loading-indicator');
    const submitBtn = document.getElementById('submit-btn');
    
    // Remove estado de carregamento
    btnText.classList.remove('hidden');
    loadingIndicator.classList.add('hidden');
    submitBtn.disabled = false;
    
    console.error('Erro na requisição:', event.detail.xhr);
    showError('Erro ao enviar formulário');
}

// Form validation
document.getElementById('projetoForm').addEventListener('submit', function(e) {
    const requiredFields = ['nome_projeto', 'tipo_empreendimento', 'natureza', 'cliente_id', 'terreno_id'];
    let isValid = true;
    
    requiredFields.forEach(fieldName => {
        const field = document.getElementById(fieldName);
        if (!field.value.trim()) {
            field.classList.add('border-red-500');
            isValid = false;
            
            // Destaca visualmente campos obrigatórios não preenchidos
            if (fieldName === 'cliente_id') {
                document.getElementById('cliente_nome').classList.add('border-red-500');
            } else if (fieldName === 'terreno_id') {
                document.getElementById('terreno_info').classList.add('border-red-500');
            }
        } else {
            field.classList.remove('border-red-500');
            
            // Remove destaque visual
            if (fieldName === 'cliente_id') {
                document.getElementById('cliente_nome').classList.remove('border-red-500');
            } else if (fieldName === 'terreno_id') {
                document.getElementById('terreno_info').classList.remove('border-red-500');
            }
        }
    });
    
    // Validação condicional por natureza
    const natureza = document.getElementById('natureza').value;
    
    // Para loteamentos e desmembramentos
    if (natureza === 'Desmembramento' || natureza === 'Loteamento e Condomínio') {
        const areaMinima = document.getElementById('area_minima_lote');
        if (!areaMinima.value.trim()) {
            areaMinima.classList.add('border-red-500');
            isValid = false;
        } else {
            areaMinima.classList.remove('border-red-500');
        }
    }
    
    // Para projetos arquitetônicos
    if (natureza === 'Arquitetonico') {
        const camposObrigatorios = ['pavimentos', 'altura_total', 'area_construida'];
        camposObrigatorios.forEach(campoId => {
            const campo = document.getElementById(campoId);
            if (!campo.value.trim()) {
                campo.classList.add('border-red-500');
                isValid = false;
            } else {
                campo.classList.remove('border-red-500');
            }
        });
        
        // Validação específica do campo pavimentos baseada na zona
        const terrenoId = document.getElementById('terreno_id').value;
        const pavimentos = document.getElementById('pavimentos').value;
        
        if (terrenoId && pavimentos) {
            const pavimentosField = document.getElementById('pavimentos');
            const maxPavimentos = parseInt(pavimentosField.max);
            
            if (parseInt(pavimentos) > maxPavimentos) {
                pavimentosField.classList.add('border-red-500');
                isValid = false;
                alert(`Número de pavimentos (${pavimentos}) excede o limite permitido para esta zona (${maxPavimentos}).`);
            } else {
                pavimentosField.classList.remove('border-red-500');
            }
        }
    }
    
    // Para projetos urbanísticos
    if (natureza === 'Urbanistico') {
        const areaConstruida = document.getElementById('area_construida');
        if (!areaConstruida.value.trim()) {
            areaConstruida.classList.add('border-red-500');
            isValid = false;
        } else {
            areaConstruida.classList.remove('border-red-500');
        }
    }
    
    if (!isValid) {
        e.preventDefault();
        showError('Por favor, preencha todos os campos obrigatórios.');
    }
});

// Auto-load ao carregar a página
document.addEventListener('DOMContentLoaded', function() {
    console.log('Formulário de projetos inicializado com padrão padronizado');
    
    // Adiciona listeners para detectar interação do usuário
    const form = document.getElementById('projetoForm');
    if (form) {
        // Detecta quando usuário digita em qualquer campo
        form.addEventListener('input', function(e) {
            detectUserInteraction();
        });
        
        // Detecta quando usuário clica em qualquer campo
        form.addEventListener('focus', function(e) {
            detectUserInteraction();
        });
        
        // Detecta quando usuário seleciona em selects
        form.addEventListener('change', function(e) {
            detectUserInteraction();
        });
        
        // Detecta quando usuário clica no botão Limpar
        const limparBtn = form.querySelector('button[type="button"]');
        if (limparBtn) {
            limparBtn.addEventListener('click', function() {
                console.log('Botão Limpar clicado - cancelando limpeza automática');
                cancelAutoClear();
            });
        }
    }
});
</script>
{% endblock %}
