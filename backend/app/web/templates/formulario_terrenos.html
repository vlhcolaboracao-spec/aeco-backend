{% extends "base.html" %}

{% block title %}Formulário de Terrenos - Sistema AECO{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-6">
    <!-- Header -->
    <div class="bg-white shadow rounded-lg p-6">
        <div class="flex justify-between items-center">
            <div>
                <h2 class="text-3xl font-bold text-gray-900">Formulário de Terrenos de Projetos</h2>
                <p class="text-gray-600 mt-1">Cadastro de dados do terreno para projetos AECO</p>
            </div>
            <a href="/" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition-colors">
                Voltar ao Dashboard
            </a>
        </div>
    </div>

    <!-- Formulário -->
    <div class="bg-white shadow rounded-lg p-6">
        <form id="terreno-form" 
              hx-post="/formulario-terrenos-projetos" 
              hx-target="body"
              hx-swap="none"
              hx-indicator="#loading-indicator"
              hx-on::before-request="showLoading()"
              hx-on::after-request="handleFormResponse(event)"
              hx-on::response-error="handleFormError(event)">
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Coluna Esquerda -->
                <div class="space-y-4">
                    <h3 class="text-lg font-medium text-gray-900 border-b pb-2">Identificação do Imóvel</h3>
                    
                    <div>
                        <label for="matricula" class="block text-sm font-medium text-gray-700 mb-1">
                            Matrícula do Imóvel *
                        </label>
                        <input type="text" 
                               id="matricula" 
                               name="matricula" 
                               placeholder="Ex: 12345-67.89.012-3"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               required>
                    </div>

                    <div>
                        <label for="data" class="block text-sm font-medium text-gray-700 mb-1">
                            Data *
                        </label>
                        <input type="date" 
                               id="data" 
                               name="data" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               required>
                    </div>

                    <h3 class="text-lg font-medium text-gray-900 border-b pb-2 mt-6">Localização</h3>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="municipio" class="block text-sm font-medium text-gray-700 mb-1">
                                Município *
                            </label>
                            <input type="text" 
                                   id="municipio" 
                                   name="municipio" 
                                   placeholder="Ex: Sorriso"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   required>
                        </div>
                        
                        <div>
                            <label for="estado" class="block text-sm font-medium text-gray-700 mb-1">
                                Estado/UF *
                            </label>
                            <select id="estado" 
                                    name="estado" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    required>
                                <option value="">Selecione</option>
                                <option value="MT">Mato Grosso</option>
                                <option value="MS">Mato Grosso do Sul</option>
                                <option value="GO">Goiás</option>
                                <option value="DF">Distrito Federal</option>
                                <option value="SP">São Paulo</option>
                                <option value="RJ">Rio de Janeiro</option>
                                <option value="PR">Paraná</option>
                                <option value="RS">Rio Grande do Sul</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label for="pais" class="block text-sm font-medium text-gray-700 mb-1">
                            País
                        </label>
                        <input type="text" 
                               id="pais" 
                               name="pais" 
                               value="BRASIL"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div>
                        <label for="bairro" class="block text-sm font-medium text-gray-700 mb-1">
                            Bairro *
                        </label>
                        <input type="text" 
                               id="bairro" 
                               name="bairro" 
                               placeholder="Ex: Centro, Jardim das Américas"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               required>
                    </div>

                    <div>
                        <label for="logradouro" class="block text-sm font-medium text-gray-700 mb-1">
                            Logradouro/Rua *
                        </label>
                                <input type="text" 
                                       id="logradouro" 
                                       name="logradouro" 
                                       placeholder="Ex: Av. Porto Alegre, 2525"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               required>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="numero" class="block text-sm font-medium text-gray-700 mb-1">
                                Número *
                            </label>
                            <input type="text" 
                                   id="numero" 
                                   name="numero" 
                                   placeholder="Ex: 123, S/N"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   required>
                        </div>
                        
                        <div>
                            <label for="cep" class="block text-sm font-medium text-gray-700 mb-1">
                                CEP *
                            </label>
                            <input type="text" 
                                   id="cep" 
                                   name="cep" 
                                   placeholder="Ex: 78890-000"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   required>
                        </div>
                    </div>
                </div>

                <!-- Coluna Direita -->
                <div class="space-y-4">
                    <h3 class="text-lg font-medium text-gray-900 border-b pb-2">Características do Terreno</h3>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="lados_poligono" class="block text-sm font-medium text-gray-700 mb-1">
                                Lados do Polígono *
                            </label>
                            <input type="number" 
                                   id="lados_poligono" 
                                   name="lados_poligono" 
                                   min="3" 
                                   max="10" 
                                   value="4"
                                   onchange="updateAngulosInternos(); updateDimensoesLados()"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   required>
                        </div>
                        
                        <div>
                            <label for="tipo_lote" class="block text-sm font-medium text-gray-700 mb-1">
                                Tipo de Lote *
                            </label>
                            <select id="tipo_lote" 
                                    name="tipo_lote" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    required>
                                <option value="">Selecione</option>
                                <option value="Padrão">Padrão</option>
                                <option value="Esquina">Esquina</option>
                                <option value="Único na Quadra">Único na Quadra</option>
                            </select>
                        </div>
                    </div>

                    <!-- Ângulos Internos Dinâmicos -->
                    <div id="angulos-container">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Ângulos Internos do Polígono *
                        </label>
                        <div id="angulos-inputs" class="grid grid-cols-2 gap-2">
                            <!-- Será preenchido dinamicamente pelo JavaScript -->
                        </div>
                        <div id="soma-angulos" class="mt-2 text-sm text-gray-600">
                            Soma dos ângulos: <span id="soma-total">0.00°</span>
                        </div>
                    </div>

                    <!-- Dimensões dos Lados Dinâmicos -->
                    <div id="dimensoes-container">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Dimensões dos Lados do Terreno *
                        </label>
                        <div id="dimensoes-inputs" class="space-y-3">
                            <!-- Será preenchido dinamicamente pelo JavaScript -->
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="area" class="block text-sm font-medium text-gray-700 mb-1">
                                Área *
                            </label>
                            <input type="text" 
                                   id="area" 
                                   name="area" 
                                   placeholder="Ex: 500,50 m²"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   required>
                        </div>
                        
                        <div>
                            <label for="norte_verdadeiro" class="block text-sm font-medium text-gray-700 mb-1">
                                Norte Verdadeiro (°) *
                            </label>
                            <input type="number" 
                                   id="norte_verdadeiro" 
                                   name="norte_verdadeiro" 
                                   step="0.01" 
                                   min="0" 
                                   max="359.99"
                                   value="0"
                                   placeholder="0,00"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   required>
                        </div>
                    </div>

                    <div>
                        <label for="zona" class="block text-sm font-medium text-gray-700 mb-1">
                            Zona *
                        </label>
                        <select id="zona" 
                                name="zona" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                required>
                            <option value="">Selecione</option>
                            <option value="ZAD1">ZAD1</option>
                            <option value="ZAD2">ZAD2</option>
                            <option value="ZC1">ZC1</option>
                            <option value="ZC2">ZC2</option>
                            <option value="ZCT1">ZCT1</option>
                            <option value="ZCT2">ZCT2</option>
                            <option value="ZCT3">ZCT3</option>
                            <option value="ZCT4">ZCT4</option>
                            <option value="ZEIS">ZEIS</option>
                            <option value="ZH1">ZH1</option>
                            <option value="ZH2">ZH2</option>
                            <option value="ZH3">ZH3</option>
                            <option value="ZHL">ZHL</option>
                            <option value="ZI1">ZI1</option>
                            <option value="ZI2">ZI2</option>
                            <option value="ZIA1">ZIA1</option>
                            <option value="ZIA2">ZIA2</option>
                            <option value="ZII">ZII</option>
                        </select>
                    </div>

                    <div>
                        <label for="observacoes" class="block text-sm font-medium text-gray-700 mb-1">
                            Observações
                        </label>
                        <textarea id="observacoes" 
                                  name="observacoes" 
                                  rows="4"
                                  placeholder="Observações adicionais sobre o terreno"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                </div>
            </div>

            <!-- Botões -->
            <div class="flex justify-end space-x-4 mt-6 pt-6 border-t">
                <button type="button" 
                        onclick="resetForm()"
                        class="px-6 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors">
                    Limpar
                </button>
                <button type="submit" 
                        class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors"
                        id="submit-btn">
                    <span id="btn-text">Cadastrar Terreno</span>
                    <span id="loading-indicator" class="hidden">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Cadastrando...
                    </span>
                </button>
            </div>
        </form>

        <!-- Resposta do Formulário -->
        <div id="form-response" class="mt-4">
            <div id="success-message" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium" id="success-text">Terreno cadastrado com sucesso!</p>
                    </div>
                </div>
            </div>
            
            <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium" id="error-text">Erro ao cadastrar terreno!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

{% block scripts %}
<script>
function resetForm() {
    document.getElementById('terreno-form').reset();
    clearMessages();
    updateAngulosInternos(); // Reset ângulos também
    
    // Reset data para hoje
    const hoje = new Date().toISOString().split('T')[0];
    document.getElementById('data').value = hoje;
}

function clearMessages() {
    document.getElementById('success-message').classList.add('hidden');
    document.getElementById('error-message').classList.add('hidden');
}

function showSuccess(message) {
    clearMessages();
    document.getElementById('success-text').textContent = message;
    document.getElementById('success-message').classList.remove('hidden');
}

function showError(message) {
    clearMessages();
    document.getElementById('error-text').textContent = message;
    document.getElementById('error-message').classList.remove('hidden');
}

function showLoading() {
    const btnText = document.getElementById('btn-text');
    const loadingIndicator = document.getElementById('loading-indicator');
    const submitBtn = document.getElementById('submit-btn');
    
    // Mostra estado de carregamento
    btnText.classList.add('hidden');
    loadingIndicator.classList.remove('hidden');
    submitBtn.disabled = true;
    
    // Limpa mensagens anteriores
    clearMessages();
}

function handleFormResponse(event) {
    const btnText = document.getElementById('btn-text');
    const loadingIndicator = document.getElementById('loading-indicator');
    const submitBtn = document.getElementById('submit-btn');
    
    // Remove estado de carregamento
    btnText.classList.remove('hidden');
    loadingIndicator.classList.add('hidden');
    submitBtn.disabled = false;
    
    console.log('Resposta recebida:', event.detail.xhr.responseText);
    
    try {
        const response = JSON.parse(event.detail.xhr.responseText);
        console.log('Response parsed:', response);
        
        if (response.success) {
            showSuccess(response.message);
            // Limpa o formulário após sucesso
            setTimeout(() => {
                document.getElementById('terreno-form').reset();
                const hoje = new Date().toISOString().split('T')[0];
                document.getElementById('data').value = hoje;
                updateAngulosInternos();
                clearMessages();
            }, 2000);
        } else {
            showError(response.message || 'Erro desconhecido');
        }
    } catch (error) {
        console.error('Erro ao processar resposta:', error);
        showError('Erro de comunicação com o servidor');
    }
}

function handleFormError(event) {
    const btnText = document.getElementById('btn-text');
    const loadingIndicator = document.getElementById('loading-indicator');
    const submitBtn = document.getElementById('submit-btn');
    
    // Remove estado de carregamento
    btnText.classList.remove('hidden');
    loadingIndicator.classList.add('hidden');
    submitBtn.disabled = false;
    
    console.error('Erro na requisição:', event.detail.xhr);
    showError('Erro ao enviar formulário');
}

function updateAngulosInternos() {
    const lados = parseInt(document.getElementById('lados_poligono').value) || 4;
    const container = document.getElementById('angulos-inputs');
    
    // Limpa container
    container.innerHTML = '';
    
    // Cria inputs para cada ângulo
    for (let i = 1; i <= lados; i++) {
        const div = document.createElement('div');
        div.className = 'flex items-center space-x-2';
        
        const label = document.createElement('label');
        label.textContent = `Ângulo ${i}:`;
        label.className = 'text-sm font-medium text-gray-700 min-w-20';
        
        const input = document.createElement('input');
        input.type = 'number';
        input.name = `angulo_${i}`;
        input.id = `angulo_${i}`;
        input.step = '0.01';
        input.min = '0';
        input.max = '180';
        input.placeholder = '90';
        input.value = '90'; // Valor padrão
        input.className = 'w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500';
        input.addEventListener('input', updateSomaAngulos);
        
        const span = document.createElement('span');
        span.textContent = '°';
        span.className = 'text-sm text-gray-600';
        
        div.appendChild(label);
        div.appendChild(input);
        div.appendChild(span);
        container.appendChild(div);
    }
    
    updateSomaAngulos();
}

function updateSomaAngulos() {
    const inputs = document.querySelectorAll('input[name="angulos_internos"]');
    let soma = 0;
    
    inputs.forEach(input => {
        const valor = parseFloat(input.value) || 0;
        soma += valor;
    });
    
    const somaElement = document.getElementById('soma-total');
    somaElement.textContent = soma.toFixed(2) + '°';
    
    // Alerta visual se exceder 360°
    if (soma > 360) {
        somaElement.parentElement.className = 'mt-2 text-sm text-red-600 font-semibold';
        somaElement.parentElement.innerHTML = `⚠️ Soma dos ângulos: <span id="soma-total">${soma.toFixed(2)}°</span> (excede 360°)`;
    } else {
        somaElement.parentElement.className = 'mt-2 text-sm text-gray-600';
        somaElement.parentElement.innerHTML = `Soma dos ângulos: <span id="soma-total">${soma.toFixed(2)}°</span>`;
    }
}

function updateDimensoesLados() {
    const lados = parseInt(document.getElementById('lados_poligono').value) || 4;
    const container = document.getElementById('dimensoes-inputs');
    
    // Limpa container
    container.innerHTML = '';
    
    // Cria inputs para cada dimensão
    for (let i = 1; i <= lados; i++) {
        const div = document.createElement('div');
        div.className = 'grid grid-cols-1 md:grid-cols-3 gap-3 items-center';
        
        const label = document.createElement('label');
        label.textContent = `Medida ${i}:`;
        label.className = 'text-sm font-medium text-gray-700';
        
        const tipoSelect = document.createElement('select');
        tipoSelect.name = `dimensao_${i}_tipo`;
        tipoSelect.id = `dimensao_${i}_tipo`;
        tipoSelect.className = 'px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500';
        
        const opcoesTipo = [
            { value: 'Alinhamento Predial', text: 'Alinhamento Predial' },
            { value: 'Fundos', text: 'Fundos' },
            { value: 'Divisa Lateral', text: 'Divisa Lateral' }
        ];
        
        opcoesTipo.forEach(opcao => {
            const option = document.createElement('option');
            option.value = opcao.value;
            option.textContent = opcao.text;
            tipoSelect.appendChild(option);
        });
        
        // Container flex para input + unidade
        const inputContainer = document.createElement('div');
        inputContainer.className = 'flex items-center space-x-2';
        
        const medidaInput = document.createElement('input');
        medidaInput.type = 'number';
        medidaInput.name = `dimensao_${i}_medida`;
        medidaInput.id = `dimensao_${i}_medida`;
        medidaInput.step = '0.01';
        medidaInput.min = '0.01';
        medidaInput.max = '999999.99';
        medidaInput.placeholder = '0.00';
        medidaInput.className = 'w-24 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500';
        
        const unidadeSpan = document.createElement('span');
        unidadeSpan.textContent = 'm';
        unidadeSpan.className = 'text-sm text-gray-600 min-w-4';
        
        inputContainer.appendChild(medidaInput);
        inputContainer.appendChild(unidadeSpan);
        
        div.appendChild(label);
        div.appendChild(tipoSelect);
        div.appendChild(inputContainer);
        container.appendChild(div);
    }
}

// Auto-load da lista ao carregar a página
document.addEventListener('DOMContentLoaded', function() {
    // Define data padrão como hoje
    const hoje = new Date().toISOString().split('T')[0];
    document.getElementById('data').value = hoje;
    
    // Inicializa os ângulos internos e dimensões
    updateAngulosInternos();
    updateDimensoesLados();
});
</script>
{% endblock %}
{% endblock %}
