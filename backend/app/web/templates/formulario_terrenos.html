{% extends "base.html" %}

{% block title %}Formulário de Terrenos - Sistema AECO{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-6">
    <!-- Header -->
    <div class="bg-white shadow rounded-lg p-6">
        <div class="flex justify-between items-center">
            <div>
                <h2 class="text-3xl font-bold text-gray-900">Formulário de Terrenos de Projetos</h2>
                <p class="text-gray-600 mt-1">Cadastro de dados do terreno para projetos AECO</p>
            </div>
            <a href="/" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition-colors">
                Voltar ao Dashboard
            </a>
        </div>
    </div>

    <!-- Formulário -->
    <div class="bg-white shadow rounded-lg p-6">
        <form id="terreno-form" 
              hx-post="/formulario-terrenos-projetos" 
              hx-target="body"
              hx-swap="none"
              hx-indicator="#loading-indicator"
              hx-on::before-request="showLoading()"
              hx-on::after-request="handleFormResponse(event)"
              hx-on::response-error="handleFormError(event)">
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Coluna Esquerda -->
                <div class="space-y-4">
                    <h3 class="text-lg font-medium text-gray-900 border-b pb-2">Identificação do Imóvel</h3>
                    
                    <div>
                        <label for="matricula" class="block text-sm font-medium text-gray-700 mb-1">
                            Matrícula do Imóvel *
                        </label>
                        <input type="text" 
                               id="matricula" 
                               name="matricula" 
                               placeholder="Ex: 12345-67.89.012-3"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               required>
                    </div>

                    <div>
                        <label for="data" class="block text-sm font-medium text-gray-700 mb-1">
                            Data *
                        </label>
                        <input type="date" 
                               id="data" 
                               name="data" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               required>
                    </div>

                    <h3 class="text-lg font-medium text-gray-900 border-b pb-2 mt-6">Localização</h3>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="municipio" class="block text-sm font-medium text-gray-700 mb-1">
                                Município *
                            </label>
                            <input type="text" 
                                   id="municipio" 
                                   name="municipio" 
                                   placeholder="Ex: Sorriso"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   required>
                        </div>
                        
                        <div>
                            <label for="estado" class="block text-sm font-medium text-gray-700 mb-1">
                                Estado/UF *
                            </label>
                            <select id="estado" 
                                    name="estado" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    required>
                                <option value="">Selecione</option>
                                <option value="MT">Mato Grosso</option>
                                <option value="MS">Mato Grosso do Sul</option>
                                <option value="GO">Goiás</option>
                                <option value="DF">Distrito Federal</option>
                                <option value="SP">São Paulo</option>
                                <option value="RJ">Rio de Janeiro</option>
                                <option value="PR">Paraná</option>
                                <option value="RS">Rio Grande do Sul</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label for="pais" class="block text-sm font-medium text-gray-700 mb-1">
                            País
                        </label>
                        <input type="text" 
                               id="pais" 
                               name="pais" 
                               value="BRASIL"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div>
                        <label for="bairro" class="block text-sm font-medium text-gray-700 mb-1">
                            Bairro *
                        </label>
                        <input type="text" 
                               id="bairro" 
                               name="bairro" 
                               placeholder="Ex: Centro, Jardim das Américas"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               required>
                    </div>

                    <div>
                        <label for="logradouro" class="block text-sm font-medium text-gray-700 mb-1">
                            Logradouro/Rua *
                        </label>
                                <input type="text" 
                                       id="logradouro" 
                                       name="logradouro" 
                                       placeholder="Ex: Av. Porto Alegre, 2525"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               required>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="numero" class="block text-sm font-medium text-gray-700 mb-1">
                                Número *
                            </label>
                            <input type="text" 
                                   id="numero" 
                                   name="numero" 
                                   placeholder="Ex: 123, S/N"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   required>
                        </div>
                        
                        <div>
                            <label for="cep" class="block text-sm font-medium text-gray-700 mb-1">
                                CEP *
                            </label>
                            <input type="text" 
                                   id="cep" 
                                   name="cep" 
                                   placeholder="Ex: 78890-000"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   required>
                        </div>
                    </div>
                </div>

                <!-- Coluna Direita -->
                <div class="space-y-4">
                    <h3 class="text-lg font-medium text-gray-900 border-b pb-2">Características do Terreno</h3>
                    
                    <!-- ZONA (Primeiro campo - prioritário) -->
                    <div>
                        <label for="zona" class="block text-sm font-medium text-gray-700 mb-1">
                            Zona Urbana *
                            <span class="text-blue-500 text-sm">⭐ Campo prioritário - determina validações</span>
                        </label>
                        <select id="zona" 
                                name="zona" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                required
                                onchange="handleZonaChange(this.value)">
                            <option value="">Selecione a zona</option>
                            <option value="ZAD1">ZAD1 - Zona de Adensamento</option>
                            <option value="ZAD2">ZAD2 - Zona de Adensamento</option>
                            <option value="ZC1">ZC1 - Zona Central</option>
                            <option value="ZC2">ZC2 - Zona Central</option>
                            <option value="ZCT1">ZCT1 - Zona de Transição</option>
                            <option value="ZCT2">ZCT2 - Zona de Transição</option>
                            <option value="ZCT3">ZCT3 - Zona de Transição</option>
                            <option value="ZCT4">ZCT4 - Zona de Transição</option>
                            <option value="ZEIS">ZEIS - Zona Especial</option>
                            <option value="ZH1">ZH1 - Zona Habitacional</option>
                            <option value="ZH2">ZH2 - Zona Habitacional</option>
                            <option value="ZH3">ZH3 - Zona Habitacional</option>
                            <option value="ZHL">ZHL - Zona Habitacional</option>
                            <option value="ZI1">ZI1 - Zona Industrial</option>
                            <option value="ZI2">ZI2 - Zona Industrial</option>
                            <option value="ZIA1">ZIA1 - Zona Industrial</option>
                            <option value="ZIA2">ZIA2 - Zona Industrial</option>
                            <option value="ZII">ZII - Zona Industrial</option>
                        </select>
                        <div id="zona-validation" class="mt-2"></div>
                        <div id="debug-info" class="mt-2 text-xs text-gray-500" style="display: none;">
                            <div>Debug: <span id="debug-text"></span></div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label for="lados_poligono" class="block text-sm font-medium text-gray-700 mb-1">
                                Lados do Polígono *
                            </label>
                            <input type="number" 
                                   id="lados_poligono" 
                                   name="lados_poligono" 
                                   min="3" 
                                   max="10" 
                                   value="4"
                                   onchange="updateAngulosInternos(); updateDimensoesLados()"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   required>
                        </div>
                        
                        <div>
                            <label for="tipo_lote" class="block text-sm font-medium text-gray-700 mb-1">
                                Tipo de Lote *
                            </label>
                            <select id="tipo_lote" 
                                    name="tipo_lote" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    required>
                                <option value="">Selecione</option>
                                <option value="Padrão">Padrão</option>
                                <option value="Esquina">Esquina</option>
                                <option value="Único na Quadra">Único na Quadra</option>
                            </select>
                        </div>

                        <!-- Tipologia removida - agora está no projeto -->
                    </div>

                    <!-- Ângulos Internos Dinâmicos -->
                    <div id="angulos-container">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Ângulos Internos do Polígono *
                        </label>
                        <div id="angulos-inputs" class="grid grid-cols-2 gap-2">
                            <!-- Será preenchido dinamicamente pelo JavaScript -->
                        </div>
                        <div id="soma-angulos" class="mt-2 text-sm text-gray-600">
                            Soma dos ângulos: <span id="soma-total">0.00°</span>
                        </div>
                    </div>

                    <!-- Dimensões dos Lados Dinâmicos -->
                    <div id="dimensoes-container">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Dimensões dos Lados do Terreno *
                        </label>
                        <div id="dimensoes-inputs" class="space-y-3">
                            <!-- Será preenchido dinamicamente pelo JavaScript -->
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="area" class="block text-sm font-medium text-gray-700 mb-1">
                                Área *
                            </label>
                            <input type="text" 
                                   id="area" 
                                   name="area" 
                                   placeholder="Ex: 500,50 m²"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   required>
                        </div>
                        
                        <div>
                            <label for="norte_verdadeiro" class="block text-sm font-medium text-gray-700 mb-1">
                                Norte Verdadeiro (°) *
                            </label>
                            <input type="number" 
                                   id="norte_verdadeiro" 
                                   name="norte_verdadeiro" 
                                   step="0.01" 
                                   min="0" 
                                   max="359.99"
                                   value="0"
                                   placeholder="0,00"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   required>
                        </div>
                    </div>

                    <!-- Zona movida para o início do formulário -->

                    <div>
                        <label for="observacoes" class="block text-sm font-medium text-gray-700 mb-1">
                            Observações
                        </label>
                        <textarea id="observacoes" 
                                  name="observacoes" 
                                  rows="4"
                                  placeholder="Observações adicionais sobre o terreno"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                </div>
            </div>

            <!-- Botões -->
            <div class="flex justify-end space-x-4 mt-6 pt-6 border-t">
                <button type="button" 
                        onclick="resetForm()"
                        class="px-6 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors">
                    Limpar
                </button>
                <button type="submit" 
                        class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors"
                        id="submit-btn">
                    <span id="btn-text">Cadastrar Terreno</span>
                    <span id="loading-indicator" class="hidden">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Cadastrando...
                    </span>
                </button>
            </div>
        </form>

        <!-- Resposta do Formulário -->
        <div id="form-response" class="mt-4">
            <div id="success-message" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium" id="success-text">Terreno cadastrado com sucesso!</p>
                    </div>
                </div>
            </div>
            
            <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium" id="error-text">Erro ao cadastrar terreno!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

{% block scripts %}
<script>
function resetForm() {
    document.getElementById('terreno-form').reset();
    clearMessages();
    updateAngulosInternos(); // Reset ângulos também
    
    // Reset data para hoje
    const hoje = new Date().toISOString().split('T')[0];
    document.getElementById('data').value = hoje;
}

function clearMessages() {
    document.getElementById('success-message').classList.add('hidden');
    document.getElementById('error-message').classList.add('hidden');
}

function showSuccess(message) {
    clearMessages();
    document.getElementById('success-text').textContent = message;
    document.getElementById('success-message').classList.remove('hidden');
}

function showError(message) {
    clearMessages();
    document.getElementById('error-text').textContent = message;
    document.getElementById('error-message').classList.remove('hidden');
}

function showLoading() {
    const btnText = document.getElementById('btn-text');
    const loadingIndicator = document.getElementById('loading-indicator');
    const submitBtn = document.getElementById('submit-btn');
    
    // Mostra estado de carregamento
    btnText.classList.add('hidden');
    loadingIndicator.classList.remove('hidden');
    submitBtn.disabled = true;
    
    // Limpa mensagens anteriores
    clearMessages();
}

function handleFormResponse(event) {
    const btnText = document.getElementById('btn-text');
    const loadingIndicator = document.getElementById('loading-indicator');
    const submitBtn = document.getElementById('submit-btn');
    
    // Remove estado de carregamento
    btnText.classList.remove('hidden');
    loadingIndicator.classList.add('hidden');
    submitBtn.disabled = false;
    
    console.log('Resposta recebida:', event.detail.xhr.responseText);
    
    try {
        const response = JSON.parse(event.detail.xhr.responseText);
        console.log('Response parsed:', response);
        
        if (response.success) {
            showSuccess(response.message);
            // Limpa o formulário após sucesso
            setTimeout(() => {
                document.getElementById('terreno-form').reset();
                const hoje = new Date().toISOString().split('T')[0];
                document.getElementById('data').value = hoje;
                updateAngulosInternos();
                clearMessages();
            }, 2000);
        } else {
            showError(response.message || 'Erro desconhecido');
        }
    } catch (error) {
        console.error('Erro ao processar resposta:', error);
        showError('Erro de comunicação com o servidor');
    }
}

function handleFormError(event) {
    const btnText = document.getElementById('btn-text');
    const loadingIndicator = document.getElementById('loading-indicator');
    const submitBtn = document.getElementById('submit-btn');
    
    // Remove estado de carregamento
    btnText.classList.remove('hidden');
    loadingIndicator.classList.add('hidden');
    submitBtn.disabled = false;
    
    console.error('Erro na requisição:', event.detail.xhr);
    showError('Erro ao enviar formulário');
}

function updateAngulosInternos() {
    const lados = parseInt(document.getElementById('lados_poligono').value) || 4;
    const container = document.getElementById('angulos-inputs');
    
    // Limpa container
    container.innerHTML = '';
    
    // Cria inputs para cada ângulo
    for (let i = 1; i <= lados; i++) {
        const div = document.createElement('div');
        div.className = 'flex items-center space-x-2';
        
        const label = document.createElement('label');
        label.textContent = `Ângulo ${i}:`;
        label.className = 'text-sm font-medium text-gray-700 min-w-20';
        
        const input = document.createElement('input');
        input.type = 'number';
        input.name = `angulo_${i}`;
        input.id = `angulo_${i}`;
        input.step = '0.01';
        input.min = '0';
        input.max = '180';
        input.placeholder = '90';
        input.value = '90'; // Valor padrão
        input.className = 'w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500';
        input.addEventListener('input', updateSomaAngulos);
        
        const span = document.createElement('span');
        span.textContent = '°';
        span.className = 'text-sm text-gray-600';
        
        div.appendChild(label);
        div.appendChild(input);
        div.appendChild(span);
        container.appendChild(div);
    }
    
    updateSomaAngulos();
}

function updateSomaAngulos() {
    const inputs = document.querySelectorAll('input[name="angulos_internos"]');
    let soma = 0;
    
    inputs.forEach(input => {
        const valor = parseFloat(input.value) || 0;
        soma += valor;
    });
    
    const somaElement = document.getElementById('soma-total');
    somaElement.textContent = soma.toFixed(2) + '°';
    
    // Alerta visual se exceder 360°
    if (soma > 360) {
        somaElement.parentElement.className = 'mt-2 text-sm text-red-600 font-semibold';
        somaElement.parentElement.innerHTML = `⚠️ Soma dos ângulos: <span id="soma-total">${soma.toFixed(2)}°</span> (excede 360°)`;
    } else {
        somaElement.parentElement.className = 'mt-2 text-sm text-gray-600';
        somaElement.parentElement.innerHTML = `Soma dos ângulos: <span id="soma-total">${soma.toFixed(2)}°</span>`;
    }
}

function updateDimensoesLados() {
    const lados = parseInt(document.getElementById('lados_poligono').value) || 4;
    const container = document.getElementById('dimensoes-inputs');
    
    // Limpa container
    container.innerHTML = '';
    
    // Cria inputs para cada dimensão
    for (let i = 1; i <= lados; i++) {
        const div = document.createElement('div');
        div.className = 'grid grid-cols-1 md:grid-cols-3 gap-3 items-center';
        
        const label = document.createElement('label');
        label.textContent = `Medida ${i}:`;
        label.className = 'text-sm font-medium text-gray-700';
        
        const tipoSelect = document.createElement('select');
        tipoSelect.name = `dimensao_${i}_tipo`;
        tipoSelect.id = `dimensao_${i}_tipo`;
        tipoSelect.className = 'px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500';
        
        const opcoesTipo = [
            { value: 'Alinhamento Predial', text: 'Alinhamento Predial' },
            { value: 'Fundos', text: 'Fundos' },
            { value: 'Divisa Lateral', text: 'Divisa Lateral' }
        ];
        
        opcoesTipo.forEach(opcao => {
            const option = document.createElement('option');
            option.value = opcao.value;
            option.textContent = opcao.text;
            tipoSelect.appendChild(option);
        });
        
        // Container flex para input + unidade
        const inputContainer = document.createElement('div');
        inputContainer.className = 'flex items-center space-x-2';
        
        const medidaInput = document.createElement('input');
        medidaInput.type = 'number';
        medidaInput.name = `dimensao_${i}_medida`;
        medidaInput.id = `dimensao_${i}_medida`;
        medidaInput.step = '0.01';
        medidaInput.min = '0.01';
        medidaInput.max = '999999.99';
        medidaInput.placeholder = '0.00';
        medidaInput.className = 'w-24 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500';
        
        const unidadeSpan = document.createElement('span');
        unidadeSpan.textContent = 'm';
        unidadeSpan.className = 'text-sm text-gray-600 min-w-4';
        
        inputContainer.appendChild(medidaInput);
        inputContainer.appendChild(unidadeSpan);
        
        div.appendChild(label);
        div.appendChild(tipoSelect);
        div.appendChild(inputContainer);
        container.appendChild(div);
    }
}

// Auto-load da lista ao carregar a página
document.addEventListener('DOMContentLoaded', function() {
    // Define data padrão como hoje
    const hoje = new Date().toISOString().split('T')[0];
    document.getElementById('data').value = hoje;
    
    // Inicializa os ângulos internos e dimensões
    updateAngulosInternos();
    updateDimensoesLados();
});

// ===== FUNCIONALIDADES DE VALIDAÇÃO DINÂMICA POR ZONA =====

// Armazena dados do formulário para preservação
let formData = {};

// Função para salvar dados do formulário
function saveFormData() {
    const form = document.getElementById('terreno-form');
    const formDataObj = new FormData(form);
    
    // Salva todos os dados do formulário
    for (let [key, value] of formDataObj.entries()) {
        formData[key] = value;
    }
}

// Função para restaurar dados do formulário
function restoreFormData() {
    console.log('=== INICIANDO RESTAURAÇÃO DE DADOS ===');
    console.log('Dados a restaurar:', formData);
    
    let restoredCount = 0;
    
    for (let [key, value] of Object.entries(formData)) {
        const element = document.querySelector(`[name="${key}"]`);
        if (element && element.type !== 'file') {
            console.log(`Processando campo ${key}: valor atual="${element.value}", valor salvo="${value}"`);
            
            // Se o campo está vazio, restaura o valor salvo
            if (!element.value || element.value.trim() === '') {
                if (value && value.trim() !== '') {
                    element.value = value;
                    console.log(`✅ Campo ${key} restaurado com valor: ${value}`);
                    restoredCount++;
                } else {
                    console.log(`⚠️ Campo ${key} não tem valor para restaurar`);
                }
            } else {
                console.log(`ℹ️ Campo ${key} já tem valor, mantendo: ${element.value}`);
            }
        } else {
            console.log(`⚠️ Campo ${key} não encontrado ou é arquivo`);
        }
    }
    
    console.log(`=== RESTAURAÇÃO CONCLUÍDA: ${restoredCount} campos restaurados ===`);
}

// Função principal para lidar com mudança de zona
function handleZonaChange(zona) {
    console.log('=== MUDANÇA DE ZONA INICIADA ===');
    console.log('Zona selecionada:', zona);
    showDebug(`Mudança de zona para: ${zona}`);
    
    if (!zona) {
        console.log('Nenhuma zona selecionada, limpando validações');
        showDebug('Zona desmarcada, limpando validações');
        clearFieldValidation();
        return;
    }
    
    // Salva dados atuais ANTES de fazer qualquer coisa
    console.log('Salvando dados atuais...');
    saveFormData();
    console.log('Dados salvos:', formData);
    showDebug(`Dados salvos: ${Object.keys(formData).length} campos`);
    
    // Busca validações para a zona
    console.log('Buscando validações para zona:', zona);
    showDebug(`Buscando validações para zona: ${zona}`);
    
    fetch(`/projetos/validacao/zona/${zona}`)
        .then(response => {
            console.log('Resposta recebida:', response.status);
            showDebug(`Resposta recebida: ${response.status}`);
            return response.json();
        })
        .then(data => {
            console.log('Dados de validação:', data);
            showDebug(`Validações recebidas: ${data.campos_obrigatorios ? data.campos_obrigatorios.length : 0} campos obrigatórios`);
            
            if (data.success) {
                console.log('Aplicando validações...');
                updateFieldValidation(data);
                
                // Restaura dados APÓS validação com delay maior
                console.log('Restaurando dados em 200ms...');
                showDebug('Aplicando validações e restaurando dados...');
                setTimeout(() => {
                    console.log('Executando restauração de dados...');
                    restoreFormData();
                    console.log('=== DADOS RESTAURADOS ===');
                    showDebug('Dados restaurados com sucesso!');
                }, 200);
            } else {
                console.log('Erro na validação, restaurando dados mesmo assim');
                showDebug('Erro na validação, restaurando dados...');
                restoreFormData();
            }
        })
        .catch(error => {
            console.error('Erro ao validar zona:', error);
            console.log('Restaurando dados mesmo com erro');
            showDebug('Erro na requisição, restaurando dados...');
            restoreFormData();
        });
}

// Função para atualizar validação dos campos
function updateFieldValidation(validationData) {
    // Remove indicadores anteriores
    clearFieldValidation();
    
    // Adiciona indicadores para campos obrigatórios
    if (validationData.campos_obrigatorios) {
        validationData.campos_obrigatorios.forEach(campo => {
            addRequiredIndicator(campo);
        });
    }
    
    // Adiciona indicadores para campos condicionais
    if (validationData.campos_condicionais) {
        validationData.campos_condicionais.forEach(campo => {
            addRequiredIndicator(campo);
        });
    }
    
    // Mostra/oculta campos baseado na zona
    if (validationData.campos_visiveis) {
        validationData.campos_visiveis.forEach(campo => {
            showField(campo);
        });
    }
    
    if (validationData.campos_ocultos) {
        validationData.campos_ocultos.forEach(campo => {
            hideField(campo);
        });
    }
}

// Função para adicionar indicador de campo obrigatório
function addRequiredIndicator(fieldName) {
    const field = document.querySelector(`[name="${fieldName}"]`);
    if (!field) return;
    
    const label = document.querySelector(`label[for="${fieldName}"]`);
    if (!label) return;
    
    // Adiciona asterisco se não existir
    if (!label.innerHTML.includes('*')) {
        label.innerHTML = label.innerHTML.replace('</label>', ' *</label>');
    }
    
    // Adiciona classe para campo obrigatório
    field.classList.add('required-field');
    field.setAttribute('data-required', 'true');
}

// Função para remover indicadores de validação
function clearFieldValidation() {
    // Remove asteriscos dos labels
    document.querySelectorAll('label').forEach(label => {
        if (label.innerHTML.includes(' *')) {
            label.innerHTML = label.innerHTML.replace(' *', '');
        }
    });
    
    // Remove classes de validação
    document.querySelectorAll('.required-field').forEach(field => {
        field.classList.remove('required-field', 'field-error');
        field.removeAttribute('data-required');
    });
}

// Função para mostrar campo
function showField(fieldName) {
    const field = document.querySelector(`[name="${fieldName}"]`);
    if (field) {
        const fieldContainer = field.closest('div');
        if (fieldContainer) {
            fieldContainer.style.display = 'block';
        }
    }
}

// Função para ocultar campo
function hideField(fieldName) {
    const field = document.querySelector(`[name="${fieldName}"]`);
    if (field) {
        const fieldContainer = field.closest('div');
        if (fieldContainer) {
            fieldContainer.style.display = 'none';
        }
    }
}

// Função para validar formulário antes do envio
function validateForm() {
    let isValid = true;
    const errors = [];
    
    // Remove erros anteriores
    clearFieldErrors();
    
    // Valida campos obrigatórios
    document.querySelectorAll('[data-required="true"]').forEach(field => {
        if (!field.value || field.value.trim() === '') {
            addFieldError(field, 'Este campo é obrigatório');
            isValid = false;
        }
    });
    
    // Validações específicas por tipo de campo
    validateSpecificFields();
    
    return isValid;
}

// Função para adicionar erro visual ao campo
function addFieldError(field, message) {
    field.classList.add('field-error');
    
    // Adiciona mensagem de erro
    let errorElement = field.parentNode.querySelector('.field-error-message');
    if (!errorElement) {
        errorElement = document.createElement('div');
        errorElement.className = 'field-error-message text-red-600 text-sm mt-1';
        field.parentNode.appendChild(errorElement);
    }
    errorElement.textContent = message;
}

// Função para remover erros dos campos
function clearFieldErrors() {
    document.querySelectorAll('.field-error').forEach(field => {
        field.classList.remove('field-error');
    });
    
    document.querySelectorAll('.field-error-message').forEach(error => {
        error.remove();
    });
}

// Função para validações específicas
function validateSpecificFields() {
    // Validação de matrícula
    const matricula = document.querySelector('[name="matricula"]');
    if (matricula && matricula.value) {
        if (!/^[0-9-\.]+$/.test(matricula.value)) {
            addFieldError(matricula, 'Matrícula deve conter apenas números, hífens e pontos');
        }
    }
    
    // Validação de CEP
    const cep = document.querySelector('[name="cep"]');
    if (cep && cep.value) {
        if (!/^\d{5}-?\d{3}$/.test(cep.value)) {
            addFieldError(cep, 'CEP deve estar no formato 00000-000');
        }
    }
    
    // Validação de área
    const area = document.querySelector('[name="area"]');
    if (area && area.value) {
        const areaValue = parseFloat(area.value);
        if (isNaN(areaValue) || areaValue <= 0) {
            addFieldError(area, 'Área deve ser um número positivo');
        }
    }
}

// Intercepta envio do formulário para validação
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('terreno-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            if (!validateForm()) {
                e.preventDefault();
                e.stopPropagation();
                
                // Mostra mensagem de erro geral
                showGeneralError('Por favor, corrija os erros destacados em vermelho antes de continuar.');
            }
        });
    }
});

// Função para mostrar erro geral
function showGeneralError(message) {
    let errorContainer = document.getElementById('general-error');
    if (!errorContainer) {
        errorContainer = document.createElement('div');
        errorContainer.id = 'general-error';
        errorContainer.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4';
        const form = document.getElementById('terreno-form');
        form.insertBefore(errorContainer, form.firstChild);
    }
    errorContainer.innerHTML = `
        <div class="flex items-center">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
            </svg>
            ${message}
        </div>
    `;
    
    // Remove erro após 5 segundos
    setTimeout(() => {
        if (errorContainer) {
            errorContainer.remove();
        }
    }, 5000);
}

// Salva dados do formulário periodicamente
setInterval(saveFormData, 2000);

// Função de debug para mostrar informações na tela
function showDebug(message) {
    const debugDiv = document.getElementById('debug-info');
    const debugText = document.getElementById('debug-text');
    if (debugDiv && debugText) {
        debugDiv.style.display = 'block';
        debugText.textContent = message;
        console.log('DEBUG:', message);
    }
}

// Salva dados quando o usuário digita
document.addEventListener('DOMContentLoaded', function() {
    // Adiciona listeners para salvar dados em tempo real
    const form = document.getElementById('terreno-form');
    if (form) {
        form.addEventListener('input', function(e) {
            if (e.target.name) {
                saveFormData();
                showDebug(`Dados salvos automaticamente (${Object.keys(formData).length} campos)`);
            }
        });
        
        form.addEventListener('change', function(e) {
            if (e.target.name) {
                saveFormData();
                showDebug(`Dados salvos por mudança (${Object.keys(formData).length} campos)`);
            }
        });
    }
    
    showDebug('Sistema de preservação de dados inicializado');
});
</script>

<style>
/* Estilos para validação visual */
.field-error {
    border-color: #ef4444 !important;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
}

.required-field {
    border-left: 3px solid #3b82f6;
}

.field-error-message {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Destaque para campos obrigatórios */
label:has(+ input[data-required="true"]),
label:has(+ select[data-required="true"]) {
    font-weight: 600;
    color: #1f2937;
}

label:has(+ input[data-required="true"])::after,
label:has(+ select[data-required="true"])::after {
    content: " *";
    color: #ef4444;
    font-weight: bold;
}
</style>

{% endblock %}
{% endblock %}
