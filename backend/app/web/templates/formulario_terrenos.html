{% extends "base.html" %}

{% block title %}Formulário de Terrenos - Sistema AECO{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-6">
    <!-- Header -->
    <div class="bg-white shadow rounded-lg p-6">
        <div class="flex justify-between items-center">
            <div>
                <h2 class="text-3xl font-bold text-gray-900">Formulário de Terrenos de Projetos</h2>
                <p class="text-gray-600 mt-1">Cadastro de dados do terreno para projetos AECO</p>
            </div>
            <a href="/" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition-colors">
                Voltar ao Dashboard
            </a>
        </div>
    </div>

    <!-- Formulário -->
    <div class="bg-white shadow rounded-lg p-6">
        <form id="terreno-form" 
              hx-post="/formulario-terrenos-projetos" 
              hx-target="#form-response" 
              hx-swap="innerHTML">
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Coluna Esquerda -->
                <div class="space-y-4">
                    <h3 class="text-lg font-medium text-gray-900 border-b pb-2">Identificação do Imóvel</h3>
                    
                    <div>
                        <label for="matricula" class="block text-sm font-medium text-gray-700 mb-1">
                            Matrícula do Imóvel *
                        </label>
                        <input type="text" 
                               id="matricula" 
                               name="matricula" 
                               placeholder="Ex: 12345-67.89.012-3"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               required>
                    </div>

                    <div>
                        <label for="data" class="block text-sm font-medium text-gray-700 mb-1">
                            Data *
                        </label>
                        <input type="date" 
                               id="data" 
                               name="data" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               required>
                    </div>

                    <h3 class="text-lg font-medium text-gray-900 border-b pb-2 mt-6">Localização</h3>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="municipio" class="block text-sm font-medium text-gray-700 mb-1">
                                Município *
                            </label>
                            <input type="text" 
                                   id="municipio" 
                                   name="municipio" 
                                   placeholder="Ex: Sorriso"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   required>
                        </div>
                        
                        <div>
                            <label for="estado" class="block text-sm font-medium text-gray-700 mb-1">
                                Estado/UF *
                            </label>
                            <select id="estado" 
                                    name="estado" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    required>
                                <option value="">Selecione</option>
                                <option value="MT">Mato Grosso</option>
                                <option value="MS">Mato Grosso do Sul</option>
                                <option value="GO">Goiás</option>
                                <option value="DF">Distrito Federal</option>
                                <option value="SP">São Paulo</option>
                                <option value="RJ">Rio de Janeiro</option>
                                <option value="PR">Paraná</option>
                                <option value="RS">Rio Grande do Sul</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label for="pais" class="block text-sm font-medium text-gray-700 mb-1">
                            País
                        </label>
                        <input type="text" 
                               id="pais" 
                               name="pais" 
                               value="BRASIL"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div>
                        <label for="bairro" class="block text-sm font-medium text-gray-700 mb-1">
                            Bairro *
                        </label>
                        <input type="text" 
                               id="bairro" 
                               name="bairro" 
                               placeholder="Ex: Centro, Jardim das Américas"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               required>
                    </div>

                    <div>
                        <label for="logradouro" class="block text-sm font-medium text-gray-700 mb-1">
                            Logradouro/Rua *
                        </label>
                                <input type="text" 
                                       id="logradouro" 
                                       name="logradouro" 
                                       placeholder="Ex: Av. Porto Alegre, 2525"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               required>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="numero" class="block text-sm font-medium text-gray-700 mb-1">
                                Número *
                            </label>
                            <input type="text" 
                                   id="numero" 
                                   name="numero" 
                                   placeholder="Ex: 123, S/N"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   required>
                        </div>
                        
                        <div>
                            <label for="cep" class="block text-sm font-medium text-gray-700 mb-1">
                                CEP *
                            </label>
                            <input type="text" 
                                   id="cep" 
                                   name="cep" 
                                   placeholder="Ex: 78890-000"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   required>
                        </div>
                    </div>
                </div>

                <!-- Coluna Direita -->
                <div class="space-y-4">
                    <h3 class="text-lg font-medium text-gray-900 border-b pb-2">Características do Terreno</h3>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="lados_poligono" class="block text-sm font-medium text-gray-700 mb-1">
                                Lados do Polígono *
                            </label>
                            <input type="number" 
                                   id="lados_poligono" 
                                   name="lados_poligono" 
                                   min="3" 
                                   max="10" 
                                   value="4"
                                   onchange="updateAngulosInternos()"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   required>
                        </div>
                        
                        <div>
                            <label for="tipo_lote" class="block text-sm font-medium text-gray-700 mb-1">
                                Tipo de Lote *
                            </label>
                            <select id="tipo_lote" 
                                    name="tipo_lote" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    required>
                                <option value="">Selecione</option>
                                <option value="Padrão">Padrão</option>
                                <option value="Esquina">Esquina</option>
                                <option value="Único na Quadra">Único na Quadra</option>
                            </select>
                        </div>
                    </div>

                    <!-- Ângulos Internos Dinâmicos -->
                    <div id="angulos-container">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Ângulos Internos do Polígono *
                        </label>
                        <div id="angulos-inputs" class="grid grid-cols-2 gap-2">
                            <!-- Será preenchido dinamicamente pelo JavaScript -->
                        </div>
                        <div id="soma-angulos" class="mt-2 text-sm text-gray-600">
                            Soma dos ângulos: <span id="soma-total">0.00°</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="area" class="block text-sm font-medium text-gray-700 mb-1">
                                Área *
                            </label>
                            <input type="text" 
                                   id="area" 
                                   name="area" 
                                   placeholder="Ex: 500,50 m²"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   required>
                        </div>
                        
                        <div>
                            <label for="norte_verdadeiro" class="block text-sm font-medium text-gray-700 mb-1">
                                Norte Verdadeiro (°) *
                            </label>
                            <input type="number" 
                                   id="norte_verdadeiro" 
                                   name="norte_verdadeiro" 
                                   step="0.01" 
                                   min="0" 
                                   max="359.99"
                                   value="0"
                                   placeholder="0,00"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   required>
                        </div>
                    </div>

                    <div>
                        <label for="zona" class="block text-sm font-medium text-gray-700 mb-1">
                            Zona *
                        </label>
                        <select id="zona" 
                                name="zona" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                required>
                            <option value="">Selecione</option>
                            <option value="ZAD1">ZAD1</option>
                            <option value="ZAD2">ZAD2</option>
                            <option value="ZC1">ZC1</option>
                            <option value="ZC2">ZC2</option>
                            <option value="ZCT1">ZCT1</option>
                            <option value="ZCT2">ZCT2</option>
                            <option value="ZCT3">ZCT3</option>
                            <option value="ZCT4">ZCT4</option>
                            <option value="ZEIS">ZEIS</option>
                            <option value="ZH1">ZH1</option>
                            <option value="ZH2">ZH2</option>
                            <option value="ZH3">ZH3</option>
                            <option value="ZHL">ZHL</option>
                            <option value="ZI1">ZI1</option>
                            <option value="ZI2">ZI2</option>
                            <option value="ZIA1">ZIA1</option>
                            <option value="ZIA2">ZIA2</option>
                            <option value="ZII">ZII</option>
                        </select>
                    </div>

                    <div>
                        <label for="observacoes" class="block text-sm font-medium text-gray-700 mb-1">
                            Observações
                        </label>
                        <textarea id="observacoes" 
                                  name="observacoes" 
                                  rows="4"
                                  placeholder="Observações adicionais sobre o terreno"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                </div>
            </div>

            <!-- Botões -->
            <div class="flex justify-end space-x-4 mt-6 pt-6 border-t">
                <button type="button" 
                        onclick="resetForm()"
                        class="px-6 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors">
                    Limpar
                </button>
                <button type="submit" 
                        class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                    Cadastrar Terreno
                </button>
            </div>
        </form>

        <!-- Resposta do Formulário -->
        <div id="form-response" class="mt-4"></div>
    </div>

    <!-- Lista de Terrenos -->
    <div class="bg-white shadow rounded-lg p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-medium text-gray-900">Terrenos Cadastrados</h3>
            <button 
                hx-get="/terrenos-list" 
                hx-target="#terrenos-list" 
                hx-trigger="click"
                class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                Carregar Lista
            </button>
        </div>
        <div id="terrenos-list">
            <div class="text-gray-500 text-sm">Clique em "Carregar Lista" para ver os terrenos cadastrados</div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
function resetForm() {
    document.getElementById('terreno-form').reset();
    document.getElementById('form-response').innerHTML = '';
    updateAngulosInternos(); // Reset ângulos também
}

function updateAngulosInternos() {
    const lados = parseInt(document.getElementById('lados_poligono').value) || 4;
    const container = document.getElementById('angulos-inputs');
    
    // Limpa container
    container.innerHTML = '';
    
    // Cria inputs para cada ângulo
    for (let i = 1; i <= lados; i++) {
        const div = document.createElement('div');
        div.className = 'flex items-center space-x-2';
        
        const label = document.createElement('label');
        label.textContent = `Ângulo ${i}:`;
        label.className = 'text-sm font-medium text-gray-700 min-w-20';
        
        const input = document.createElement('input');
        input.type = 'number';
        input.name = 'angulos_internos';
        input.id = `angulo_${i}`;
        input.step = '0.01';
        input.min = '0';
        input.max = '180';
        input.placeholder = '0.00';
        input.className = 'w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500';
        input.addEventListener('input', updateSomaAngulos);
        
        const span = document.createElement('span');
        span.textContent = '°';
        span.className = 'text-sm text-gray-600';
        
        div.appendChild(label);
        div.appendChild(input);
        div.appendChild(span);
        container.appendChild(div);
    }
    
    updateSomaAngulos();
}

function updateSomaAngulos() {
    const inputs = document.querySelectorAll('input[name="angulos_internos"]');
    let soma = 0;
    
    inputs.forEach(input => {
        const valor = parseFloat(input.value) || 0;
        soma += valor;
    });
    
    const somaElement = document.getElementById('soma-total');
    somaElement.textContent = soma.toFixed(2) + '°';
    
    // Alerta visual se exceder 360°
    if (soma > 360) {
        somaElement.parentElement.className = 'mt-2 text-sm text-red-600 font-semibold';
        somaElement.parentElement.innerHTML = `⚠️ Soma dos ângulos: <span id="soma-total">${soma.toFixed(2)}°</span> (excede 360°)`;
    } else {
        somaElement.parentElement.className = 'mt-2 text-sm text-gray-600';
        somaElement.parentElement.innerHTML = `Soma dos ângulos: <span id="soma-total">${soma.toFixed(2)}°</span>`;
    }
}

// Auto-load da lista ao carregar a página
document.addEventListener('DOMContentLoaded', function() {
    // Define data padrão como hoje
    const hoje = new Date().toISOString().split('T')[0];
    document.getElementById('data').value = hoje;
    
    // Inicializa os ângulos internos
    updateAngulosInternos();
    
    // Carrega a lista de terrenos automaticamente
    htmx.trigger('#terrenos-list', 'click');
});
</script>
{% endblock %}
{% endblock %}
