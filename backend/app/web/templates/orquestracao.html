{% extends "base.html" %}

{% block title %}Orquestração de Processos - Sistema AECO{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-6">
    <!-- Header -->
    <div class="bg-white shadow rounded-lg p-6">
        <div class="flex justify-between items-center">
            <div>
                <h2 class="text-3xl font-bold text-gray-900">Orquestração de Processos</h2>
                <p class="text-gray-600 mt-1">Composição e execução de sequências de processos Revit</p>
            </div>
            <a href="/" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition-colors">
                Voltar ao Dashboard
            </a>
        </div>
    </div>

    <!-- Status do Sistema -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Status Revit -->
        <div class="bg-white shadow rounded-lg p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                        <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                </div>
                <div class="ml-4">
                    <h3 class="text-lg font-medium text-gray-900">Status Revit</h3>
                    <p class="text-sm text-green-600 font-medium">Online</p>
                </div>
            </div>
        </div>

        <!-- Processos Ativos -->
        <div class="bg-white shadow rounded-lg p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                        <svg class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                </div>
                <div class="ml-4">
                    <h3 class="text-lg font-medium text-gray-900">Processos Ativos</h3>
                    <p class="text-sm text-blue-600 font-medium">0 em execução</p>
                </div>
            </div>
        </div>

        <!-- Última Execução -->
        <div class="bg-white shadow rounded-lg p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center">
                        <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                </div>
                <div class="ml-4">
                    <h3 class="text-lg font-medium text-gray-900">Última Execução</h3>
                    <p class="text-sm text-gray-600">Nenhuma execução</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Área Principal -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Lista de Processos Disponíveis -->
        <div class="lg:col-span-1">
            <div class="bg-white shadow rounded-lg p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Processos Disponíveis</h3>
                
                <!-- Filtros -->
                <div class="mb-4 space-y-2">
                    <input type="text" 
                           placeholder="Buscar processo..." 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    
                    <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Todas as categorias</option>
                        <option value="arquitetura">Arquitetura</option>
                        <option value="estrutura">Estrutura</option>
                        <option value="mep">MEP</option>
                        <option value="coordenacao">Coordenação</option>
                        <option value="documentacao">Documentação</option>
                        <option value="analise">Análise</option>
                    </select>
                </div>

                <!-- Lista de Processos -->
                <div class="space-y-2 max-h-96 overflow-y-auto">
                    <!-- Exemplo de processo -->
                    <div class="border border-gray-200 rounded-md p-3 hover:bg-gray-50 cursor-pointer transition-colors" 
                         onclick="addProcessToList('proc-1')">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="text-sm font-medium text-gray-900">Criar Projeto Base</h4>
                                <p class="text-xs text-gray-500">Arquitetura • v1.0.0</p>
                            </div>
                            <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">Ativo</span>
                        </div>
                        <p class="text-xs text-gray-600 mt-1">Cria um novo projeto arquitetônico a partir de template</p>
                    </div>

                    <div class="border border-gray-200 rounded-md p-3 hover:bg-gray-50 cursor-pointer transition-colors" 
                         onclick="addProcessToList('proc-2')">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="text-sm font-medium text-gray-900">Configurar Parâmetros</h4>
                                <p class="text-xs text-gray-500">Arquitetura • v1.2.0</p>
                            </div>
                            <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">Ativo</span>
                        </div>
                        <p class="text-xs text-gray-600 mt-1">Configura parâmetros de projeto automaticamente</p>
                    </div>

                    <div class="border border-gray-200 rounded-md p-3 hover:bg-gray-50 cursor-pointer transition-colors" 
                         onclick="addProcessToList('proc-3')">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="text-sm font-medium text-gray-900">Gerar Plantas</h4>
                                <p class="text-xs text-gray-500">Documentação • v2.1.0</p>
                            </div>
                            <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">Ativo</span>
                        </div>
                        <p class="text-xs text-gray-600 mt-1">Gera plantas baixas automaticamente</p>
                    </div>

                    <!-- Placeholder para mais processos -->
                    <div class="text-center py-4 text-gray-500 text-sm">
                        <p>Cadastre processos em <a href="/processos" class="text-blue-600 hover:text-blue-800">Processos</a></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Área de Composição -->
        <div class="lg:col-span-2">
            <div class="bg-white shadow rounded-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Sequência de Execução</h3>
                    <button onclick="saveSequence()" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Salvar Sequência
                    </button>
                </div>

                <!-- Área de Drop -->
                <div id="sequence-area" class="min-h-96 border-2 border-dashed border-gray-300 rounded-lg p-4">
                    <div class="text-center text-gray-500">
                        <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <p class="text-lg font-medium mb-2">Arraste processos aqui</p>
                        <p class="text-sm">Clique nos processos à esquerda para adicioná-los à sequência</p>
                    </div>
                </div>

                <!-- Controles de Execução -->
                <div class="mt-6 pt-4 border-t">
                    <div class="flex justify-between items-center">
                        <div class="flex space-x-2">
                            <button onclick="executeSequence()" 
                                    class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path>
                                </svg>
                                Executar Sequência
                            </button>
                            <button onclick="testSequence()" 
                                    class="px-6 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500">
                                <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                                </svg>
                                Testar Sequência
                            </button>
                            <button onclick="clearSequence()" 
                                    class="px-6 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                                <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                </svg>
                                Limpar
                            </button>
                        </div>
                        
                        <div class="text-sm text-gray-500">
                            <span id="sequence-count">0</span> processos na sequência
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Configuração de Processo -->
    <div id="config-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                <div class="px-6 py-4 border-b">
                    <h3 class="text-lg font-medium text-gray-900">Configurar Processo</h3>
                </div>
                <div class="px-6 py-4">
                    <form id="process-config-form">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Parâmetros do Processo
                                </label>
                                <textarea id="process-params" 
                                          rows="4"
                                          placeholder="Insira os parâmetros em formato JSON..."
                                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Condições de Execução
                                </label>
                                <select id="execution-condition" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="always">Sempre executar</option>
                                    <option value="on_success">Executar apenas se anterior teve sucesso</option>
                                    <option value="on_error">Executar apenas se anterior falhou</option>
                                    <option value="conditional">Executar condicionalmente</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="px-6 py-4 border-t flex justify-end space-x-2">
                    <button onclick="closeConfigModal()" 
                            class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button onclick="saveProcessConfig()" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        Salvar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let sequenceProcesses = [];
let currentConfigProcess = null;

function addProcessToList(processId) {
    // Simular dados do processo
    const processData = {
        id: processId,
        name: processId === 'proc-1' ? 'Criar Projeto Base' : 
              processId === 'proc-2' ? 'Configurar Parâmetros' : 'Gerar Plantas',
        category: processId === 'proc-1' ? 'Arquitetura' : 
                  processId === 'proc-2' ? 'Arquitetura' : 'Documentação',
        version: processId === 'proc-1' ? 'v1.0.0' : 
                 processId === 'proc-2' ? 'v1.2.0' : 'v2.1.0'
    };
    
    // Verificar se já está na sequência
    if (sequenceProcesses.find(p => p.id === processId)) {
        showNotification('Processo já está na sequência', 'warning');
        return;
    }
    
    // Adicionar à sequência
    sequenceProcesses.push(processData);
    updateSequenceDisplay();
    showNotification(`Processo "${processData.name}" adicionado à sequência`, 'success');
}

function updateSequenceDisplay() {
    const sequenceArea = document.getElementById('sequence-area');
    const countElement = document.getElementById('sequence-count');
    
    countElement.textContent = sequenceProcesses.length;
    
    if (sequenceProcesses.length === 0) {
        sequenceArea.innerHTML = `
            <div class="text-center text-gray-500">
                <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <p class="text-lg font-medium mb-2">Arraste processos aqui</p>
                <p class="text-sm">Clique nos processos à esquerda para adicioná-los à sequência</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="space-y-3">';
    sequenceProcesses.forEach((process, index) => {
        html += `
            <div class="flex items-center p-3 border border-gray-200 rounded-md bg-gray-50">
                <div class="flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-medium">
                    ${index + 1}
                </div>
                <div class="ml-3 flex-grow">
                    <h4 class="text-sm font-medium text-gray-900">${process.name}</h4>
                    <p class="text-xs text-gray-500">${process.category} • ${process.version}</p>
                </div>
                <div class="flex space-x-2">
                    <button onclick="configureProcess(${index})" 
                            class="text-blue-600 hover:text-blue-800 text-sm">
                        Configurar
                    </button>
                    <button onclick="removeProcess(${index})" 
                            class="text-red-600 hover:text-red-800 text-sm">
                        Remover
                    </button>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    sequenceArea.innerHTML = html;
}

function configureProcess(index) {
    currentConfigProcess = index;
    document.getElementById('config-modal').classList.remove('hidden');
}

function closeConfigModal() {
    document.getElementById('config-modal').classList.add('hidden');
    currentConfigProcess = null;
}

function saveProcessConfig() {
    if (currentConfigProcess !== null) {
        const params = document.getElementById('process-params').value;
        const condition = document.getElementById('execution-condition').value;
        
        sequenceProcesses[currentConfigProcess].params = params;
        sequenceProcesses[currentConfigProcess].condition = condition;
        
        closeConfigModal();
        showNotification('Configuração salva', 'success');
    }
}

function removeProcess(index) {
    sequenceProcesses.splice(index, 1);
    updateSequenceDisplay();
    showNotification('Processo removido da sequência', 'info');
}

function executeSequence() {
    if (sequenceProcesses.length === 0) {
        showNotification('Adicione pelo menos um processo à sequência', 'warning');
        return;
    }
    
    showNotification('Iniciando execução da sequência...', 'info');
    // Aqui seria implementada a lógica de execução
}

function testSequence() {
    if (sequenceProcesses.length === 0) {
        showNotification('Adicione pelo menos um processo à sequência', 'warning');
        return;
    }
    
    showNotification('Testando sequência...', 'info');
    // Aqui seria implementada a lógica de teste
}

function clearSequence() {
    if (sequenceProcesses.length > 0) {
        if (confirm('Tem certeza que deseja limpar toda a sequência?')) {
            sequenceProcesses = [];
            updateSequenceDisplay();
            showNotification('Sequência limpa', 'info');
        }
    }
}

function saveSequence() {
    if (sequenceProcesses.length === 0) {
        showNotification('Adicione pelo menos um processo à sequência', 'warning');
        return;
    }
    
    showNotification('Sequência salva com sucesso!', 'success');
    // Aqui seria implementada a lógica de salvamento
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-md shadow-lg z-50 ${
        type === 'success' ? 'bg-green-600 text-white' : 
        type === 'error' ? 'bg-red-600 text-white' :
        type === 'warning' ? 'bg-yellow-600 text-white' :
        'bg-blue-600 text-white'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}
</script>
{% endblock %}
